<html>
<head>
<style>
div {
    font-size: 14px;
}
h1 {
    text-align: center;
}
.container {
    margin: 0px auto;
    width: 1180px;
}
textarea.diff_area {
    width: 580px;
    height: 300px;
}
.operation-container {
    margin: 10px auto;
    width: 350px;
}
#search_depth_input {
    width: 60px;
}
#step_chart {
    width: 580px;
    height: 400px;
    display: inline-block;
    border: 1px solid #999;
}
.diff-result {
    display: inline-block;
}
#diff_result {
    width: 580px;
    height: 400px;
}
</style>
<script src="js/myers.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.1.0.rc2/echarts-en.common.js"></script>
<script>
window.onload = () => {
    let srcTextArea = document.getElementById('src_txt');
    let dstTextArea = document.getElementById('dst_txt');
    let diffResult = document.getElementById('diff_result');
    let findAllStepsSel = document.getElementById('find_all_steps_sel');
    let searchDepthInput = document.getElementById('search_depth_input');
    let chart = echarts.init(document.getElementById('step_chart'));

    document.getElementById('compare_btn').onclick = ev => {
        let srcText = srcTextArea.value;
        let dstText = dstTextArea.value;
        let findAllSteps = findAllStepsSel.value === 'true';
        let diff = new MyersDiff({
            srcArr: srcText.split(/\r|\n/),
            dstArr: dstText.split(/\r|\n/), 
            findAllSteps,
            maxSearchDepth: searchDepthInput.value
        });
        diffResult.value = diff.calDiff().getSimpleDiff().join('\n');
        window.diff = diff;
        refreshChart(diff);
    };

    chart.on('click', params => {
        if (params.componentType == 'series') {
            let [d, k] = params.data;
            diffResult.value = diff.getSimpleDiff({d, k}).join('\n');
        }
    });

    function refreshChart(diff) {
        let stepSet = new Set();
        let series = [];
        for (let finalStep of diff.getFinalSteps()) {
            let data = generateDataByLastStep(finalStep, stepSet);
            if (data.length <= 1) {
                continue;
            }
            series.push({type: 'line', data});
        }
        for (let d of Object.keys(diff.prevStepMapping).reverse()) {
            for (let k of Object.keys(diff.prevStepMapping[d])) {
                let data = generateDataByLastStep({d, k}, stepSet);
                if (data.length <= 1) {
                    continue;
                }
                series.push({
                    type: 'line',
                    lineStyle: {
                        normal: {
                            type: 'dashed'
                        }
                    },
                    data
                });
            }
        }
        chart.setOption({
            title: {
                text: '',
                x: 'center'
            },
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.7)',
                borderColor: '#ccc',
                borderWidth: 1,
                textStyle: {
                    color: '#666'
                },
                formatter(params) {
                    let [d, k] = params.data;
                    let pos = diff.getPosition(d, k);
                    return [
                        `pos: (x=${pos.x}, y=${pos.y})`,
                        `step: (d=${d}, k=${k})`
                    ].join('<br/>')
                }
            },
            animation: false,
            grid: {
                left: 35,
                right: 20,
                top: 20,
                bottom: 35
            },
            dataZoom: {
                type: 'inside',
                zoomOnMouseWheel: 'ctrl'
            },
            xAxis: {
                name: 'd',
                nameLocation: 'middle',
                type: 'value'
            },
            yAxis: {
                name: 'k = x - y',
                nameLocation: 'middle',
                type: 'value'
            },
            series: series
        }, true);
    }

    function generateDataByLastStep(lastStep, stepSet) {
        let steps = diff.getSteps(lastStep).map(step => {
            step.key = step.d + ',' + step.k;
            return step;
        });
        let data = [];
        for (let step of steps.reverse()) {
            data.unshift([step.d, step.k]);
            if (stepSet.has(step.key)) {
                break;
            }
            stepSet.add(step.key);
        }
        return data;
    }
}
</script>
</head>
<body>
    <h1>基于Myers算法的文本比对工具</h1>
    <div class="container">
        <textarea id="src_txt" class="diff_area" placeholder="请输入源文件内容"></textarea>
        <textarea id="dst_txt" class="diff_area" placeholder="请输入目标文件内容"></textarea>
    </div>
    <div class="operation-container">
        计算所有路径
        <select id="find_all_steps_sel">
            <option value="true">是</option>
            <option value="false" selected>否</option>
        </select>
        / 搜索深度
        <input id="search_depth_input" value="1000"/>
        / <button id="compare_btn">比较</button>
    </div>
    <div class="container">
        <div id="step_chart"></div>
        <div class="diff-result">
            <textarea id="diff_result"></textarea>
        </div>
    </div>
</body>
</html>